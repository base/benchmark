# Go test workflow
name: test

on:
  push:
    branches: ["main"]
  pull_request:

# Set minimal permissions for all jobs by default
permissions:
  contents: read

jobs:
  go-lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0

      - name: Install project dependencies
        run: |
          go mod download

      - name: Lint Go
        uses: golangci/golangci-lint-action@1481404843c368bc19ca9406f87d6e0fc97bdcfd # v7.0.0
        with:
          version: v2.0

  go-test:
    outputs:
      COVERAGE: ${{ steps.unit.outputs.coverage }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0

      - name: Install project dependencies
        run: |
          go mod download
      - name: Run Unit Tests
        id: unit
        run: |
          go test -v -coverprofile=coverage.out ./...

  # Call the reusable workflow that builds all binaries in parallel
  build-binaries:
    uses: ./.github/workflows/_build-binaries.yaml
    with:
      reth_version: 27a8c0f5a6dfb27dea84c5751776ecabdd069646
      geth_version: 6cbfcd5161083bcd4052edc3022d9f99c6fe40e0
      rbuilder_version: 23f42c8e78ba3abb45a8840df7037a27e196e601

  run-examples:
    runs-on: ubuntu-latest
    needs: build-binaries
    permissions:
      contents: read
      actions: read # Required for artifact download
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0

      - name: Install project dependencies
        run: |
          go mod download

      - name: Download contract artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: contracts
          path: out/

      - name: Download reth binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: reth
          path: ${{ runner.temp }}/bin/

      - name: Download geth binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: geth
          path: ${{ runner.temp }}/bin/

      - name: Download rbuilder binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: rbuilder
          path: ${{ runner.temp }}/bin/

      - name: Download op-program binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: op-program
          path: ${{ runner.temp }}/bin/

      - name: Make binaries executable
        run: |
          chmod +x ${{ runner.temp }}/bin/*
          echo "Downloaded binaries:"
          ls -la ${{ runner.temp }}/bin

      - name: Setup op-program directory
        run: |
          mkdir -p op-program/versions/v1.6.1-rc.1
          cp ${{ runner.temp }}/bin/op-program op-program/versions/v1.6.1-rc.1/
          du -h -d 2 .

      - name: Run examples
        run: |
          ./.github/scripts/run-example-benchmarks.sh ${{ runner.temp }}
